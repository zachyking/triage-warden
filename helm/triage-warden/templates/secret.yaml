{{- if and .Values.secrets.create (not .Values.secrets.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "triage-warden.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "triage-warden.labels" . | nindent 4 }}
  {{- with .Values.secrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  {{- if .Values.secrets.encryptionKey }}
  TW_ENCRYPTION_KEY: {{ .Values.secrets.encryptionKey | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.jwtSecret }}
  TW_JWT_SECRET: {{ .Values.secrets.jwtSecret | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.sessionSecret }}
  TW_SESSION_SECRET: {{ .Values.secrets.sessionSecret | b64enc | quote }}
  {{- end }}
  {{- if and .Values.postgresql.password (not .Values.postgresql.existingSecret) }}
  DATABASE_URL: {{ include "triage-warden.databaseUrl" . | b64enc | quote }}
  {{- end }}
  {{- if and .Values.redis.password (not .Values.redis.existingSecret) }}
  REDIS_URL: {{ include "triage-warden.redisUrl" . | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{- /*
Note: This template supports using external secrets managers.
To use an existing secret, set secrets.existingSecret to the name of your secret.
The secret should contain the following keys:
  - TW_ENCRYPTION_KEY: 32-byte base64 encoded encryption key
  - TW_JWT_SECRET: JWT signing secret (min 32 characters)
  - TW_SESSION_SECRET: Session encryption secret (min 32 characters)
  - DATABASE_URL: Full PostgreSQL connection URL (if not using postgresql.existingSecret)

For external secrets operators (e.g., external-secrets, vault-secrets-operator),
create an ExternalSecret resource that provisions a secret with these keys.

Example ExternalSecret (external-secrets operator):

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "triage-warden.fullname" . }}-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: {{ include "triage-warden.fullname" . }}-secrets
    creationPolicy: Owner
  data:
    - secretKey: TW_ENCRYPTION_KEY
      remoteRef:
        key: secret/triage-warden
        property: encryption-key
    - secretKey: TW_JWT_SECRET
      remoteRef:
        key: secret/triage-warden
        property: jwt-secret
    - secretKey: TW_SESSION_SECRET
      remoteRef:
        key: secret/triage-warden
        property: session-secret
    - secretKey: DATABASE_URL
      remoteRef:
        key: secret/triage-warden
        property: database-url
*/ -}}
