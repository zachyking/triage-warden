# Triage Warden - Production Docker Compose
#
# Required environment variables:
#   TW_ENCRYPTION_KEY - 32-byte base64 key for credential encryption (openssl rand -base64 32)
#   TW_JWT_SECRET     - Secret for JWT signing (min 32 characters)
#   TW_SESSION_SECRET - Secret for session signing (min 32 characters)
#   POSTGRES_PASSWORD - PostgreSQL database password
#
# Optional environment variables:
#   TW_CORS_ALLOWED_ORIGINS - Comma-separated list of allowed CORS origins
#   TW_BASE_URL             - Base URL for the application
#
# Usage: docker-compose up -d

version: '3.8'

services:
  app:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://triage:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/triage_warden
      - TW_ENCRYPTION_KEY=${TW_ENCRYPTION_KEY:?TW_ENCRYPTION_KEY is required - generate with: openssl rand -base64 32}
      - TW_JWT_SECRET=${TW_JWT_SECRET:?TW_JWT_SECRET is required - use a secure random string}
      - TW_SESSION_SECRET=${TW_SESSION_SECRET:?TW_SESSION_SECRET is required - use a secure random string}
      - TW_ENV=production
      - TW_SESSION_SECURE=true
      - TW_BASE_URL=${TW_BASE_URL:-http://localhost:8080}
      - TW_CORS_ALLOWED_ORIGINS=${TW_CORS_ALLOWED_ORIGINS:-}
      - RUST_LOG=info,triage_warden=info
      - TW_LOG_FORMAT=json
      - QDRANT_URL=http://qdrant:6334
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=triage
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=triage_warden
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U triage -d triage_warden"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  qdrant:
    image: qdrant/qdrant:v1.12.4
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

volumes:
  postgres_data:
  qdrant_data:

networks:
  default:
    name: triage-warden
