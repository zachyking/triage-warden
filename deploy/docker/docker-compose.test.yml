# Triage Warden - Integration Test Docker Compose
#
# This configuration is used for full-stack integration testing.
# It spins up all required services with test-friendly configuration.
#
# Usage:
#   docker-compose -f docker-compose.test.yml up -d
#   cargo test --test integration_tests -- --ignored
#   docker-compose -f docker-compose.test.yml down -v

version: '3.8'

services:
  # Test PostgreSQL database
  postgres-test:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: triage_warden_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d triage_warden_test"]
      interval: 2s
      timeout: 5s
      retries: 10
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster tests

  # Test Qdrant vector database
  qdrant-test:
    image: qdrant/qdrant:v1.12.4
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__STORAGE__ON_DISK_PAYLOAD: "false"  # In-memory for speed
    ports:
      - "6335:6333"  # HTTP
      - "6336:6334"  # gRPC
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 2s
      timeout: 5s
      retries: 10
    tmpfs:
      - /qdrant/storage  # Use tmpfs for faster tests

  # Test Redis (for session/cache tests)
  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10
    tmpfs:
      - /data

  # Triage Warden API in test mode
  tw-api-test:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    ports:
      - "8081:8080"
    environment:
      DATABASE_URL: postgres://test:test@postgres-test:5432/triage_warden_test
      TW_ENV: test
      TW_LOG_LEVEL: debug
      TW_ENCRYPTION_KEY: test_encryption_key_32_bytes_long!
      TW_JWT_SECRET: test_jwt_secret_for_integration_testing
      TW_SESSION_SECRET: test_session_secret_for_integration
      TW_SESSION_SECURE: "false"
      TW_BASE_URL: http://localhost:8081
      QDRANT_URL: http://qdrant-test:6334
      REDIS_URL: redis://redis-test:6379
      RUST_LOG: debug,tw_api=debug,tw_core=debug
      # Disable rate limiting for tests
      TW_RATE_LIMIT_DISABLED: "true"
      # Enable all features for testing
      TW_FEATURE_MULTI_TENANCY: "true"
      TW_FEATURE_WEBHOOKS: "true"
    depends_on:
      postgres-test:
        condition: service_healthy
      qdrant-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 10

# Network for inter-service communication
networks:
  default:
    name: triage-warden-test
    driver: bridge

# No persistent volumes - use tmpfs for speed and isolation
