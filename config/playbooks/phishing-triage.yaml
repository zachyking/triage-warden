# Phishing Triage Playbook
# ========================
# Automated workflow for triaging suspected phishing emails.

name: phishing-triage
version: "1.0"
description: "Automated triage workflow for phishing email alerts"

# Trigger conditions
trigger:
  sources:
    - email_security_gateway
    - user_reported
  alert_types:
    - suspected_phishing
    - user_reported_phishing
    - malicious_url_click
    - malicious_attachment

# Input parameters expected
input:
  required:
    - message_id        # Email message ID
    - recipient         # Email recipient
    - sender            # Email sender address
  optional:
    - subject           # Email subject
    - received_time     # When the email was received
    - reported_by       # Who reported (for user reports)

# Workflow stages
stages:
  # Stage 1: Parse and extract IOCs
  - name: extraction
    description: "Extract indicators from the email"
    steps:
      - action: parse_email
        input:
          message_id: "{{ input.message_id }}"
        output:
          - headers
          - body
          - urls
          - attachments
          - authentication  # SPF, DKIM, DMARC results

  # Stage 2: Enrich with threat intelligence
  - name: enrichment
    description: "Gather threat intelligence on extracted IOCs"
    parallel: true  # Run these in parallel
    steps:
      - action: lookup_sender_reputation
        input:
          sender: "{{ input.sender }}"
          domain: "{{ extraction.sender_domain }}"
        output:
          - sender_ti

      - action: lookup_urls
        input:
          urls: "{{ extraction.urls }}"
        output:
          - url_ti

      - action: lookup_attachments
        input:
          attachments: "{{ extraction.attachments }}"
        output:
          - attachment_ti

      - action: check_email_authentication
        input:
          headers: "{{ extraction.headers }}"
        output:
          - spf_result
          - dkim_result
          - dmarc_result

  # Stage 3: AI Analysis
  - name: ai_analysis
    description: "AI-powered analysis of the email"
    steps:
      - action: run_triage_agent
        input:
          context:
            email_headers: "{{ extraction.headers }}"
            email_body: "{{ extraction.body }}"
            urls: "{{ enrichment.url_ti }}"
            attachments: "{{ enrichment.attachment_ti }}"
            sender_reputation: "{{ enrichment.sender_ti }}"
            authentication:
              spf: "{{ enrichment.spf_result }}"
              dkim: "{{ enrichment.dkim_result }}"
              dmarc: "{{ enrichment.dmarc_result }}"
          task: |
            Analyze this email for phishing indicators. Consider:
            1. Sender reputation and authentication results
            2. URL analysis from threat intelligence
            3. Attachment analysis
            4. Email content (urgency, requests for credentials, etc.)
            5. Impersonation attempts

            Provide a verdict (true_positive, false_positive, suspicious)
            with confidence score and recommended actions.
        output:
          - verdict
          - confidence
          - summary
          - recommended_actions
          - mitre_techniques

  # Stage 4: Decision and Response
  - name: decision
    description: "Execute response based on analysis"

    # Branch based on verdict
    branches:
      # True positive - confirmed phishing
      true_positive:
        conditions:
          - verdict: true_positive
          - confidence_above: 0.8
        steps:
          - action: quarantine_email
            input:
              message_id: "{{ input.message_id }}"
            requires_approval: false  # High confidence, auto-approve

          - action: block_sender
            input:
              sender: "{{ input.sender }}"
            conditions:
              - confidence_above: 0.95
            requires_approval: true   # Still needs approval

          - action: notify_user
            input:
              recipient: "{{ input.recipient }}"
              template: phishing_confirmed
              variables:
                subject: "{{ extraction.subject }}"

          - action: create_ticket
            input:
              title: "Phishing Email - {{ extraction.subject }}"
              description: "{{ ai_analysis.summary }}"
              priority: high
              labels:
                - phishing
                - email-security
                - "{{ ai_analysis.mitre_techniques }}"

      # Likely true positive - needs some human review
      likely_true_positive:
        conditions:
          - verdict: true_positive
          - confidence_between: [0.6, 0.8]
        steps:
          - action: quarantine_email
            input:
              message_id: "{{ input.message_id }}"
            requires_approval: true  # Lower confidence, needs approval

          - action: create_ticket
            input:
              title: "[Review] Likely Phishing - {{ extraction.subject }}"
              description: "{{ ai_analysis.summary }}"
              priority: medium
              labels:
                - phishing
                - needs-review

      # Suspicious - needs investigation
      suspicious:
        conditions:
          - verdict: suspicious
        steps:
          - action: create_ticket
            input:
              title: "[Investigate] Suspicious Email - {{ extraction.subject }}"
              description: "{{ ai_analysis.summary }}"
              priority: medium
              labels:
                - suspicious
                - needs-investigation

      # False positive - benign email
      false_positive:
        conditions:
          - verdict: false_positive
          - confidence_above: 0.9
        steps:
          - action: log_false_positive
            input:
              alert_id: "{{ trigger.alert_id }}"
              reason: "{{ ai_analysis.summary }}"

          - action: notify_reporter
            conditions:
              - input.reported_by is not null
            input:
              reporter: "{{ input.reported_by }}"
              template: false_positive_thanks

      # Low confidence - escalate
      inconclusive:
        conditions:
          - confidence_below: 0.6
        steps:
          - action: escalate
            input:
              reason: "Low confidence analysis - human review required"
              context: "{{ ai_analysis }}"

          - action: create_ticket
            input:
              title: "[Escalated] Email Analysis - {{ extraction.subject }}"
              description: "{{ ai_analysis.summary }}"
              priority: high
              labels:
                - escalated
                - needs-senior-review

# SLA targets
sla:
  # Target time from alert to initial triage
  time_to_triage: 5m

  # Target time from alert to response action
  time_to_respond: 15m

  # Escalation if SLA breached
  escalation_on_breach: true

# Metrics to track
metrics:
  - name: phishing_detection_rate
    description: "Percentage of phishing emails correctly identified"

  - name: false_positive_rate
    description: "Percentage of legitimate emails incorrectly flagged"

  - name: mean_time_to_triage
    description: "Average time from alert to triage completion"

  - name: auto_resolution_rate
    description: "Percentage resolved without human intervention"
