#!/bin/bash
set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we have Rust changes
RUST_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs|toml)$' || true)
# Check if we have Python changes
PYTHON_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -n "$RUST_CHANGED" ]; then
    echo -e "${YELLOW}Checking Rust code...${NC}"

    # Format check
    echo "  Checking formatting..."
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}Formatting check failed. Run 'cargo fmt --all' to fix.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Formatting OK${NC}"

    # Clippy
    echo "  Running clippy..."
    if ! cargo clippy --workspace --exclude tw-bridge -- -D warnings; then
        echo -e "${RED}Clippy found issues. Please fix them before committing.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Clippy OK${NC}"

    # Check compilation
    echo "  Checking compilation..."
    if ! cargo check --workspace --exclude tw-bridge; then
        echo -e "${RED}Compilation check failed.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Compilation OK${NC}"
fi

if [ -n "$PYTHON_CHANGED" ]; then
    echo -e "${YELLOW}Checking Python code...${NC}"

    # Check if tools are available
    if command -v ruff &> /dev/null; then
        echo "  Running ruff..."
        if ! ruff check python/tw_ai; then
            echo -e "${RED}Ruff found issues.${NC}"
            exit 1
        fi
        echo -e "  ${GREEN}Ruff OK${NC}"
    fi

    if command -v black &> /dev/null; then
        echo "  Checking black formatting..."
        if ! black --check python/tw_ai 2>/dev/null; then
            echo -e "${RED}Black formatting check failed. Run 'black python/tw_ai' to fix.${NC}"
            exit 1
        fi
        echo -e "  ${GREEN}Black OK${NC}"
    fi
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
