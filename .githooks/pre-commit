#!/bin/bash
set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we have Rust changes
RUST_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs|toml)$' || true)
# Check if we have Python changes
PYTHON_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -n "$RUST_CHANGED" ]; then
    echo -e "${YELLOW}Checking Rust code...${NC}"

    # Format check
    echo "  Checking formatting..."
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}Formatting check failed. Run 'cargo fmt --all' to fix.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Formatting OK${NC}"

    # Clippy
    echo "  Running clippy..."
    if ! cargo clippy --workspace --exclude tw-bridge -- -D warnings; then
        echo -e "${RED}Clippy found issues. Please fix them before committing.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Clippy OK${NC}"

    # Check compilation
    echo "  Checking compilation..."
    if ! cargo check --workspace --exclude tw-bridge; then
        echo -e "${RED}Compilation check failed.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Compilation OK${NC}"

    # Run tests
    echo "  Running tests..."
    if ! cargo test --workspace --exclude tw-bridge -- --test-threads=1 2>&1 | tail -20; then
        echo -e "${RED}Tests failed.${NC}"
        exit 1
    fi
    echo -e "  ${GREEN}Tests OK${NC}"
fi

if [ -n "$PYTHON_CHANGED" ]; then
    echo -e "${YELLOW}Checking Python code...${NC}"

    # Run Python checks from the python directory using uv
    pushd python > /dev/null

    if command -v uv &> /dev/null; then
        echo "  Running ruff..."
        if ! uv run ruff check tw_ai; then
            echo -e "${RED}Ruff found issues. Run 'cd python && uv run ruff check tw_ai --fix' to auto-fix.${NC}"
            popd > /dev/null
            exit 1
        fi
        echo -e "  ${GREEN}Ruff OK${NC}"

        echo "  Checking black formatting..."
        if ! uv run black --check tw_ai 2>/dev/null; then
            echo -e "${RED}Black formatting check failed. Run 'cd python && uv run black tw_ai' to fix.${NC}"
            popd > /dev/null
            exit 1
        fi
        echo -e "  ${GREEN}Black OK${NC}"

        echo "  Running mypy..."
        if ! uv run mypy tw_ai 2>/dev/null; then
            echo -e "${RED}Mypy found type errors.${NC}"
            popd > /dev/null
            exit 1
        fi
        echo -e "  ${GREEN}Mypy OK${NC}"

        echo "  Running pytest..."
        if ! uv run pytest tests/ -v --tb=short 2>&1 | tail -20; then
            echo -e "${RED}Python tests failed.${NC}"
            popd > /dev/null
            exit 1
        fi
        echo -e "  ${GREEN}Pytest OK${NC}"
    else
        echo -e "${YELLOW}  uv not found, skipping Python checks${NC}"
    fi

    popd > /dev/null
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
