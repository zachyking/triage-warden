//! Rapid7 InsightVM vulnerability scanner connector.

use async_trait::async_trait;
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use tracing::info;

use crate::traits::{ConnectorConfig, ConnectorError, ConnectorHealth, ConnectorResult};
use crate::Connector;

use super::{ScanResult, Vulnerability, VulnerabilityScanner};

/// Configuration for the Rapid7 InsightVM connector.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Rapid7Config {
    /// Base connector configuration.
    #[serde(flatten)]
    pub connector: ConnectorConfig,
    /// Rapid7 region for InsightVM Cloud.
    pub region: Option<String>,
}

/// Rapid7 InsightVM vulnerability scanner connector.
pub struct Rapid7Connector {
    config: Rapid7Config,
}

impl Rapid7Connector {
    /// Creates a new Rapid7 InsightVM connector.
    pub fn new(config: Rapid7Config) -> Self {
        info!(
            region = config.region.as_deref().unwrap_or("default"),
            "Rapid7 InsightVM connector initialized"
        );
        Self { config }
    }
}

#[async_trait]
impl Connector for Rapid7Connector {
    fn name(&self) -> &str {
        &self.config.connector.name
    }

    fn connector_type(&self) -> &str {
        "vulnerability"
    }

    fn capabilities(&self) -> Vec<String> {
        vec![
            "health_check".to_string(),
            "test_connection".to_string(),
            "get_vulnerabilities".to_string(),
            "get_scan_results".to_string(),
        ]
    }

    async fn health_check(&self) -> ConnectorResult<ConnectorHealth> {
        // TODO: Implement actual Rapid7 API health check
        Ok(ConnectorHealth::Healthy)
    }

    async fn test_connection(&self) -> ConnectorResult<bool> {
        // TODO: Implement actual connection test against Rapid7 API
        Ok(true)
    }
}

#[async_trait]
impl VulnerabilityScanner for Rapid7Connector {
    async fn get_vulnerabilities_for_asset(
        &self,
        _asset_id: &str,
    ) -> ConnectorResult<Vec<Vulnerability>> {
        // TODO: Implement Rapid7 asset vulnerability API
        Ok(vec![])
    }

    async fn get_scan_results(&self, _scan_id: &str) -> ConnectorResult<ScanResult> {
        // TODO: Implement Rapid7 scan results API
        Err(ConnectorError::NotFound(
            "Scan results not yet implemented".to_string(),
        ))
    }

    async fn get_recent_vulnerabilities(
        &self,
        _since: DateTime<Utc>,
        _limit: Option<usize>,
    ) -> ConnectorResult<Vec<Vulnerability>> {
        // TODO: Implement Rapid7 vulnerability export API
        Ok(vec![])
    }

    async fn get_vulnerability_by_cve(
        &self,
        _cve_id: &str,
    ) -> ConnectorResult<Option<Vulnerability>> {
        // TODO: Implement CVE lookup via Rapid7
        Ok(None)
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::traits::AuthConfig;
    use std::collections::HashMap;

    fn test_config() -> Rapid7Config {
        Rapid7Config {
            connector: ConnectorConfig {
                name: "rapid7-test".to_string(),
                base_url: "https://us.api.insight.rapid7.com".to_string(),
                auth: AuthConfig::None,
                timeout_secs: 30,
                max_retries: 3,
                verify_tls: true,
                headers: HashMap::new(),
            },
            region: Some("us".to_string()),
        }
    }

    #[test]
    fn test_connector_name() {
        let connector = Rapid7Connector::new(test_config());
        assert_eq!(connector.name(), "rapid7-test");
        assert_eq!(connector.connector_type(), "vulnerability");
    }

    #[test]
    fn test_connector_capabilities() {
        let connector = Rapid7Connector::new(test_config());
        let caps = connector.capabilities();
        assert!(caps.contains(&"get_vulnerabilities".to_string()));
        assert!(caps.contains(&"get_scan_results".to_string()));
    }

    #[tokio::test]
    async fn test_health_check() {
        let connector = Rapid7Connector::new(test_config());
        let health = connector.health_check().await.unwrap();
        assert_eq!(health, ConnectorHealth::Healthy);
    }

    #[tokio::test]
    async fn test_get_recent_vulnerabilities() {
        let connector = Rapid7Connector::new(test_config());
        let vulns = connector
            .get_recent_vulnerabilities(Utc::now(), Some(10))
            .await
            .unwrap();
        assert!(vulns.is_empty());
    }
}
