<div class="modal-backdrop" id="edit-notification-modal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Edit Notification Channel</h2>
      <button class="modal-close" aria-label="Close" onclick="this.closest('.modal-backdrop').remove()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <form hx-put="/api/notifications/{{ channel.id }}" hx-swap="none" hx-on::after-request="if(event.detail.successful) { this.closest('.modal-backdrop').remove(); location.reload(); }">
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel Type</label>
          <select name="channel_type" class="form-input form-select" required onchange="updateEditNotificationFields(this.value)">
            <option value="slack" {% if channel.channel_type == "slack" %}selected{% endif %}>Slack</option>
            <option value="teams" {% if channel.channel_type == "teams" %}selected{% endif %}>Microsoft Teams</option>
            <option value="email" {% if channel.channel_type == "email" %}selected{% endif %}>Email</option>
            <option value="pagerduty" {% if channel.channel_type == "pagerduty" %}selected{% endif %}>PagerDuty</option>
            <option value="webhook" {% if channel.channel_type == "webhook" %}selected{% endif %}>Generic Webhook</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Channel Name</label>
          <input type="text" name="name" class="form-input" value="{{ channel.name }}" required>
        </div>

        <div id="edit-notification-fields">
          {% if channel.channel_type == "slack" %}
          <div class="form-group">
            <label class="form-label">Slack Webhook URL</label>
            <input type="url" name="webhook_url" class="form-input" value="{{ channel.webhook_url }}" required>
            <p class="text-xs text-muted mt-1">Create an incoming webhook in your Slack workspace</p>
          </div>
          <div class="form-group">
            <label class="form-label">Channel (optional)</label>
            <input type="text" name="channel" class="form-input" value="{{ channel.channel_name }}" placeholder="#security-alerts">
          </div>
          {% else if channel.channel_type == "teams" %}
          <div class="form-group">
            <label class="form-label">Teams Webhook URL</label>
            <input type="url" name="webhook_url" class="form-input" value="{{ channel.webhook_url }}" required>
            <p class="text-xs text-muted mt-1">Configure an incoming webhook connector in your Teams channel</p>
          </div>
          {% else if channel.channel_type == "email" %}
          <div class="form-group">
            <label class="form-label">Recipients</label>
            <input type="text" name="recipients" class="form-input" value="{{ channel.recipients }}" required>
            <p class="text-xs text-muted mt-1">Comma-separated email addresses</p>
          </div>
          <div class="grid grid-2 gap-4">
            <div class="form-group">
              <label class="form-label">SMTP Host</label>
              <input type="text" name="smtp_host" class="form-input" value="{{ channel.smtp_host }}">
            </div>
            <div class="form-group">
              <label class="form-label">SMTP Port</label>
              <input type="number" name="smtp_port" class="form-input" value="{{ channel.smtp_port }}">
            </div>
          </div>
          {% else if channel.channel_type == "pagerduty" %}
          <div class="form-group">
            <label class="form-label">PagerDuty Integration Key</label>
            <input type="password" name="integration_key" class="form-input" value="{{ channel.integration_key }}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Severity Mapping</label>
            <select name="pd_severity" class="form-input form-select">
              <option value="critical" {% if channel.pd_severity == "critical" %}selected{% endif %}>Critical incidents -> PD Critical</option>
              <option value="warning" {% if channel.pd_severity == "warning" %}selected{% endif %}>Critical incidents -> PD Warning</option>
            </select>
          </div>
          {% else %}
          <div class="form-group">
            <label class="form-label">Webhook URL</label>
            <input type="url" name="webhook_url" class="form-input" value="{{ channel.webhook_url }}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Authentication Header (optional)</label>
            <input type="password" name="auth_header" class="form-input" value="{{ channel.auth_header }}">
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label">Trigger Events</label>
          <div class="grid grid-2 gap-2 mt-2">
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="critical_incident" {% if channel.has_critical_incident %}checked{% endif %}>
              <span class="text-sm">Critical Incidents</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="approval_needed" {% if channel.has_approval_needed %}checked{% endif %}>
              <span class="text-sm">Approval Needed</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="action_executed" {% if channel.has_action_executed %}checked{% endif %}>
              <span class="text-sm">Action Executed</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="playbook_failed" {% if channel.has_playbook_failed %}checked{% endif %}>
              <span class="text-sm">Playbook Failed</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="connector_error" {% if channel.has_connector_error %}checked{% endif %}>
              <span class="text-sm">Connector Error</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" name="events[]" value="system_health" {% if channel.has_system_health %}checked{% endif %}>
              <span class="text-sm">System Health</span>
            </label>
          </div>
        </div>

        <div class="form-group mt-4">
          <div class="flex items-center gap-3">
            <label class="switch">
              <input type="checkbox" name="enabled" {% if channel.enabled %}checked{% endif %}>
              <span class="switch-track"></span>
              <span class="switch-thumb"></span>
            </label>
            <span class="text-sm">Enable notifications</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
function updateEditNotificationFields(type) {
  const container = document.getElementById('edit-notification-fields');
  let fields = '';

  switch(type) {
    case 'slack':
      fields = `
        <div class="form-group">
          <label class="form-label">Slack Webhook URL</label>
          <input type="url" name="webhook_url" class="form-input" placeholder="https://hooks.slack.com/services/..." required>
          <p class="text-xs text-muted mt-1">Create an incoming webhook in your Slack workspace</p>
        </div>
        <div class="form-group">
          <label class="form-label">Channel (optional)</label>
          <input type="text" name="channel" class="form-input" placeholder="#security-alerts">
        </div>
      `;
      break;

    case 'teams':
      fields = `
        <div class="form-group">
          <label class="form-label">Teams Webhook URL</label>
          <input type="url" name="webhook_url" class="form-input" placeholder="https://outlook.office.com/webhook/..." required>
          <p class="text-xs text-muted mt-1">Configure an incoming webhook connector in your Teams channel</p>
        </div>
      `;
      break;

    case 'email':
      fields = `
        <div class="form-group">
          <label class="form-label">Recipients</label>
          <input type="text" name="recipients" class="form-input" placeholder="soc@company.com, alerts@company.com" required>
          <p class="text-xs text-muted mt-1">Comma-separated email addresses</p>
        </div>
        <div class="grid grid-2 gap-4">
          <div class="form-group">
            <label class="form-label">SMTP Host</label>
            <input type="text" name="smtp_host" class="form-input" placeholder="smtp.company.com">
          </div>
          <div class="form-group">
            <label class="form-label">SMTP Port</label>
            <input type="number" name="smtp_port" class="form-input" value="587">
          </div>
        </div>
      `;
      break;

    case 'pagerduty':
      fields = `
        <div class="form-group">
          <label class="form-label">PagerDuty Integration Key</label>
          <input type="password" name="integration_key" class="form-input" placeholder="Events API v2 Integration Key" required>
        </div>
        <div class="form-group">
          <label class="form-label">Severity Mapping</label>
          <select name="pd_severity" class="form-input form-select">
            <option value="critical">Critical incidents -> PD Critical</option>
            <option value="warning">Critical incidents -> PD Warning</option>
          </select>
        </div>
      `;
      break;

    case 'webhook':
    default:
      fields = `
        <div class="form-group">
          <label class="form-label">Webhook URL</label>
          <input type="url" name="webhook_url" class="form-input" placeholder="https://api.example.com/webhook" required>
        </div>
        <div class="form-group">
          <label class="form-label">Authentication Header (optional)</label>
          <input type="password" name="auth_header" class="form-input" placeholder="Bearer token or API key">
        </div>
      `;
  }

  container.innerHTML = fields;
}
</script>
