<div class="modal-backdrop" onclick="closeModal()"></div>
<div class="modal">
  <div class="modal-header">
    <h3 class="modal-title">Create API Key</h3>
    <button class="modal-close" onclick="closeModal()" aria-label="Close modal">&times;</button>
  </div>
  <form hx-post="/api/api-keys"
        hx-swap="none"
        hx-on::after-request="handleApiKeyResponse(event)">
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label" for="api-key-name">Name <span class="text-critical">*</span></label>
        <input type="text" id="api-key-name" name="name" class="form-input"
               placeholder="e.g., CI/CD Pipeline, External Integration"
               required maxlength="100">
        <p class="text-xs text-muted mt-1">A descriptive name to identify this key's purpose.</p>
      </div>

      <div class="form-group mt-4">
        <label class="form-label">Scopes <span class="text-critical">*</span></label>
        <p class="text-xs text-muted mb-2">Select the permissions this API key should have.</p>
        <div class="grid grid-2 gap-2">
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="read">
            <div>
              <span class="font-medium">read</span>
              <p class="text-xs text-muted">Read access to incidents and data</p>
            </div>
          </label>
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="write">
            <div>
              <span class="font-medium">write</span>
              <p class="text-xs text-muted">Create and update resources</p>
            </div>
          </label>
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="incidents">
            <div>
              <span class="font-medium">incidents</span>
              <p class="text-xs text-muted">Full access to incidents</p>
            </div>
          </label>
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="connectors">
            <div>
              <span class="font-medium">connectors</span>
              <p class="text-xs text-muted">Manage connectors</p>
            </div>
          </label>
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="playbooks">
            <div>
              <span class="font-medium">playbooks</span>
              <p class="text-xs text-muted">Manage playbooks</p>
            </div>
          </label>
          <label class="flex items-center gap-2 p-2 bg-surface rounded cursor-pointer hover:bg-surface-hover">
            <input type="checkbox" name="scopes" value="settings">
            <div>
              <span class="font-medium">settings</span>
              <p class="text-xs text-muted">Access settings</p>
            </div>
          </label>
        </div>
      </div>

      <div class="form-group mt-4">
        <label class="form-label" for="api-key-expires">Expiration (optional)</label>
        <select id="api-key-expires" name="expires_in_days" class="form-input form-select">
          <option value="">Never expires</option>
          <option value="7">7 days</option>
          <option value="30">30 days</option>
          <option value="90">90 days</option>
          <option value="180">180 days</option>
          <option value="365">365 days</option>
        </select>
        <p class="text-xs text-muted mt-1">For security, consider setting an expiration date for production keys.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button type="submit" class="btn btn-primary">Create API Key</button>
    </div>
  </form>
</div>

<script>
function handleApiKeyResponse(event) {
  if (event.detail.successful) {
    const response = JSON.parse(event.detail.xhr.responseText);
    // Show the key in a special modal
    showApiKeyCreatedModal(response.raw_key, response.name);
  } else {
    try {
      const error = JSON.parse(event.detail.xhr.responseText);
      showToast('error', 'Failed to Create Key', error.message || 'An error occurred.');
    } catch {
      showToast('error', 'Failed to Create Key', 'An unexpected error occurred.');
    }
  }
}

function showApiKeyCreatedModal(rawKey, keyName) {
  const modalHtml = `
    <div class="modal-backdrop" onclick="closeModal(); location.reload();"></div>
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">API Key Created</h3>
      </div>
      <div class="modal-body">
        <div class="bg-success-surface p-4 rounded mb-4">
          <svg class="inline-block mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
            <path d="M22 4L12 14.01l-3-3"/>
          </svg>
          <span class="font-semibold">Success!</span> Your API key has been created.
        </div>

        <div class="bg-warning-surface p-4 rounded mb-4">
          <svg class="inline-block mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span class="font-semibold">Important:</span> This is the only time you will see this key. Copy it now and store it securely.
        </div>

        <label class="form-label">Your API Key</label>
        <div class="flex gap-2">
          <input type="text" class="form-input font-mono" value="${rawKey}" readonly id="new-api-key">
          <button type="button" class="btn btn-secondary" onclick="copyApiKey()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
            Copy
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="closeModal(); location.reload();">Done</button>
      </div>
    </div>
  `;
  document.getElementById('modal-container').innerHTML = modalHtml;
}

function copyApiKey() {
  const input = document.getElementById('new-api-key');
  input.select();
  document.execCommand('copy');
  showToast('success', 'Copied!', 'API key copied to clipboard.');
}
</script>
