{% extends "base.html" %}

{% block title %}Users - Admin - Triage Warden{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-header-content">
    <h1 class="page-title">User Management</h1>
    <p class="page-subtitle">Manage user accounts and permissions</p>
  </div>
  <div class="page-actions">
    <button class="btn btn-primary" hx-get="/web/modals/add-user" hx-target="#modal-container">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Add User
    </button>
  </div>
</div>

<!-- Search and Filters -->
<div class="filters-bar">
  <div class="filter-group">
    <input
      type="text"
      class="form-input"
      placeholder="Search users..."
      id="user-search"
      hx-get="/web/partials/users-table"
      hx-trigger="keyup changed delay:300ms"
      hx-target="#users-table-container"
      hx-include="[name='role'], [name='enabled']"
      name="search"
    >
  </div>
  <div class="filter-group">
    <select
      class="form-select"
      name="role"
      hx-get="/web/partials/users-table"
      hx-trigger="change"
      hx-target="#users-table-container"
      hx-include="#user-search, [name='enabled']"
    >
      <option value="">All Roles</option>
      <option value="admin">Admin</option>
      <option value="analyst">Analyst</option>
      <option value="viewer">Viewer</option>
    </select>
  </div>
  <div class="filter-group">
    <select
      class="form-select"
      name="enabled"
      hx-get="/web/partials/users-table"
      hx-trigger="change"
      hx-target="#users-table-container"
      hx-include="#user-search, [name='role']"
    >
      <option value="">All Status</option>
      <option value="true">Enabled</option>
      <option value="false">Disabled</option>
    </select>
  </div>
</div>

<!-- Users Table -->
<div class="card">
  <div id="users-table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            <div class="user-info">
              <div class="user-avatar">{{ user.username.chars().next().unwrap_or('?').to_ascii_uppercase() }}</div>
              <div>
                <div class="user-name">{{ user.display_name.as_deref().unwrap_or(&user.username) }}</div>
                <div class="user-username">@{{ user.username }}</div>
              </div>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="badge badge-{{ user.role }}">{{ user.role }}</span>
          </td>
          <td>
            {% if user.enabled %}
            <span class="status-badge status-active">Active</span>
            {% else %}
            <span class="status-badge status-disabled">Disabled</span>
            {% endif %}
          </td>
          <td>
            {% match user.last_login_at %}
              {% when Some with (time) %}
                {{ time }}
              {% when None %}
                <span class="text-muted">Never</span>
            {% endmatch %}
          </td>
          <td>
            <div class="action-buttons">
              <button
                class="btn btn-sm btn-ghost"
                hx-get="/web/modals/edit-user/{{ user.id }}"
                hx-target="#modal-container"
                title="Edit"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button
                class="btn btn-sm btn-ghost"
                hx-get="/web/modals/reset-password/{{ user.id }}"
                hx-target="#modal-container"
                title="Reset Password"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0110 0v4"/>
                </svg>
              </button>
              {% if !user.is_current %}
              <button
                class="btn btn-sm btn-ghost btn-danger"
                hx-delete="/api/admin/users/{{ user.id }}"
                hx-confirm="Are you sure you want to delete this user?"
                hx-target="#users-table-container"
                hx-swap="innerHTML"
                title="Delete"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if users.is_empty() %}
        <tr>
          <td colspan="6" class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" aria-hidden="true">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <p>No users found</p>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
.user-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--accent-primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.875rem;
}

.user-name {
  font-weight: 500;
  color: var(--text-primary);
}

.user-username {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.badge-admin {
  background: rgba(139, 92, 246, 0.1);
  color: rgb(139, 92, 246);
}

.badge-analyst {
  background: rgba(59, 130, 246, 0.1);
  color: rgb(59, 130, 246);
}

.badge-viewer {
  background: rgba(156, 163, 175, 0.1);
  color: rgb(156, 163, 175);
}

.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-active {
  background: rgba(34, 197, 94, 0.1);
  color: rgb(34, 197, 94);
}

.status-disabled {
  background: rgba(239, 68, 68, 0.1);
  color: rgb(239, 68, 68);
}

.action-buttons {
  display: flex;
  gap: 0.25rem;
}

.btn-danger {
  color: var(--severity-high);
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.1);
}
</style>
{% endblock %}
