<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Triage Warden{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  {% block head %}{% endblock %}
</head>
<body hx-ext="sse">
  <!-- Top Navigation -->
  <nav class="top-nav">
    <a href="/" class="logo">TRIAGE_WARDEN</a>
    <div class="nav-links">
      <a href="/" class="nav-link{% if active_nav == "dashboard" %} active{% endif %}">Dashboard</a>
      <a href="/incidents" class="nav-link{% if active_nav == "incidents" %} active{% endif %}">
        Incidents
        {% if open_count > 0 %}<span class="nav-badge">{{ open_count }}</span>{% endif %}
      </a>
      <a href="/approvals" class="nav-link{% if active_nav == "approvals" %} active{% endif %}">
        Approvals
        {% if approval_count > 0 %}<span class="nav-badge">{{ approval_count }}</span>{% endif %}
      </a>
      <a href="/playbooks" class="nav-link{% if active_nav == "playbooks" %} active{% endif %}">Playbooks</a>
      <a href="/knowledge" class="nav-link{% if active_nav == "knowledge" %} active{% endif %}">Knowledge</a>
      <a href="/analytics" class="nav-link{% if active_nav == "analytics" %} active{% endif %}">Analytics</a>
      <a href="/settings" class="nav-link{% if active_nav == "settings" %} active{% endif %}">Settings</a>
    </div>
    <div class="nav-right">
      <div class="system-status">
        <span class="status-dot{% if system_healthy %} healthy{% else %} unhealthy{% endif %}"></span>
        <span class="status-text">{% if system_healthy %}Healthy{% else %}Degraded{% endif %}</span>
      </div>
      {% match current_user %}
      {% when Some with (user) %}
      <div class="user-menu">
        <button class="user-menu-trigger" onclick="this.parentElement.classList.toggle('open')">
          <span class="user-avatar">{{ user.username.chars().next().unwrap_or('U') }}</span>
          <span class="user-info">
            <span class="user-name">{% match user.display_name %}{% when Some with (name) %}{{ name }}{% when None %}{{ user.username }}{% endmatch %}</span>
            <span class="user-role badge badge-{{ user.role }}">{{ user.role }}</span>
          </span>
          <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        <div class="user-dropdown">
          {% if user.role == "admin" %}
          <a href="/admin/users" class="dropdown-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
            </svg>
            User Management
          </a>
          <div class="dropdown-divider"></div>
          {% endif %}
          <form action="/logout" method="POST" class="dropdown-form">
            <button type="submit" class="dropdown-item dropdown-item-danger">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Sign Out
            </button>
          </form>
        </div>
      </div>
      {% when None %}
      {% endmatch %}
    </div>
  </nav>

  {% if critical_count > 0 %}
  <div class="alert-banner">
    <svg class="alert-banner-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <span class="alert-banner-text"><strong>{{ critical_count }} critical incident{% if critical_count != 1 %}s{% endif %}</strong> require{% if critical_count == 1 %}s{% endif %} immediate attention</span>
    <a href="/incidents?severity=critical" class="alert-banner-link">View Critical &rarr;</a>
  </div>
  {% endif %}

  <div class="container">
    {% block content %}{% endblock %}
  </div>

  <!-- Chat Sidebar Toggle -->
  <button class="chat-toggle-btn" onclick="document.getElementById('chat-sidebar').classList.toggle('open')" title="AI Assistant">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
    </svg>
  </button>

  <!-- NL Chat Sidebar -->
  {% include "partials/nl_chat.html" %}

  <!-- Modal Container (HTMX will inject modals here) -->
  <div id="modal-container"></div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Toast & Modal Scripts -->
  <script>
    // Toast management
    window.showToast = function(type, title, message, duration = 5000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <svg class="toast-icon ${type}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          ${type === 'success' ? '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' : ''}
          ${type === 'error' ? '<path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>' : ''}
          ${type === 'warning' ? '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>' : ''}
          ${type === 'info' ? '<path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>' : ''}
        </svg>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" aria-label="Close" onclick="this.parentElement.classList.add('removing'); setTimeout(() => this.parentElement.remove(), 200);">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <div class="toast-progress"></div>
      `;
      container.appendChild(toast);

      // Auto-remove
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 200);
      }, duration);
    };

    // Close modal on backdrop click or escape
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-backdrop')) {
        e.target.remove();
      }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelector('.modal-backdrop')?.remove();
      }
    });

    // HTMX event handlers for toast notifications
    document.body.addEventListener('showToast', function(e) {
      const { type, title, message } = e.detail;
      showToast(type, title, message);
    });

    // Global HTMX error handlers
    document.body.addEventListener('htmx:responseError', function(e) {
      const xhr = e.detail.xhr;
      let errorMessage = 'An unexpected error occurred.';

      try {
        const response = JSON.parse(xhr.responseText);
        if (response.error) {
          errorMessage = response.error;
        } else if (response.message) {
          errorMessage = response.message;
        }
      } catch {
        if (xhr.status === 400) {
          errorMessage = 'Invalid request. Please check your input.';
        } else if (xhr.status === 401) {
          errorMessage = 'Authentication required. Please log in.';
        } else if (xhr.status === 403) {
          errorMessage = 'You do not have permission to perform this action.';
        } else if (xhr.status === 404) {
          errorMessage = 'The requested resource was not found.';
        } else if (xhr.status === 422) {
          errorMessage = 'Validation failed. Please check your input.';
        } else if (xhr.status === 500) {
          errorMessage = 'Server error. Please try again later.';
        } else if (xhr.status >= 500) {
          errorMessage = 'Service unavailable. Please try again later.';
        }
      }

      showToast('error', 'Error', errorMessage);
    });

    document.body.addEventListener('htmx:sendError', function(e) {
      showToast('error', 'Network Error', 'Unable to connect to the server. Please check your connection and try again.');
    });

    // Chat helper: append user message bubble before HTMX sends the request
    window.appendUserMessage = function(text) {
      const container = document.getElementById('chat-messages');
      if (!container) return;
      const msg = document.createElement('div');
      msg.className = 'chat-message user';
      msg.innerHTML = '<div class="chat-message-content">' + text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    };

    // Show/hide typing indicator
    document.body.addEventListener('htmx:beforeRequest', function(e) {
      const indicator = document.getElementById('chat-typing');
      if (indicator && e.detail.elt.closest && e.detail.elt.closest('.chat-input-area')) {
        indicator.style.display = 'flex';
      }
    });
    document.body.addEventListener('htmx:afterRequest', function(e) {
      const indicator = document.getElementById('chat-typing');
      if (indicator) indicator.style.display = 'none';
      const container = document.getElementById('chat-messages');
      if (container) container.scrollTop = container.scrollHeight;
    });

  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
