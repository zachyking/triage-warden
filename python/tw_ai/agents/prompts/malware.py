"""
Malware and EDR triage prompt template.

Specialized system prompt for analyzing malware and endpoint detection alerts,
covering MITRE ATT&CK techniques:
- T1059.* (Command and Scripting Interpreter)
- T1055.* (Process Injection)
- T1003.* (OS Credential Dumping)
"""

from tw_ai.agents.prompts.system import (
    AVAILABLE_TOOLS,
    CHAIN_OF_THOUGHT_GUIDANCE,
    CONFIDENCE_SCORING_CRITERIA,
    SOC_ANALYST_PERSONA,
    format_output_schema,
)

# =============================================================================
# Malware-Specific Indicators
# =============================================================================

MALWARE_INDICATORS = """## Malware and EDR Indicator Analysis

### Process Execution Indicators
- **Suspicious Parent-Child**: cmd.exe spawning PowerShell, Office spawning cmd.exe
- **LOLBAS Abuse**: certutil, mshta, regsvr32, rundll32 with suspicious arguments
- **Encoded Commands**: Base64 encoded PowerShell (-enc, -encodedcommand)
- **Download Cradles**: PowerShell IEX, curl/wget to suspicious URLs
- **Execution from Temp**: Processes running from %TEMP%, %APPDATA%, Downloads

### Command Line Red Flags
- **PowerShell Flags**: -nop, -noni, -w hidden, -ep bypass, -enc
- **Obfuscation**: Character substitution, string concatenation, tick marks
- **Credential Access**: sekurlsa::, mimikatz, procdump lsass
- **Reconnaissance**: whoami, net user, net group, nltest, dsquery
- **Lateral Movement**: wmic /node:, psexec, schtasks /s:

### File System Indicators
- **Suspicious Paths**:
  - System32 with random names
  - Hidden folders in user profiles
  - %PUBLIC%, %PROGRAMDATA% executables
- **Double Extensions**: doc.exe, pdf.scr
- **Known Malware Names**: mimikatz, psexec (unauthorized), cobalt strike indicators
- **Unsigned Executables**: Running from unexpected locations

### Network Indicators
- **Beacon Patterns**: Regular interval callbacks (e.g., every 60 seconds)
- **High Entropy Domains**: Random-looking subdomain strings (DGA)
- **Unusual Ports**: HTTP on 8080, 8443, or other non-standard ports
- **Direct IP Communication**: No DNS resolution for C2
- **Data Exfil Patterns**: Large uploads, DNS tunneling

### Memory/Injection Indicators
- **Process Hollowing**: Suspended process with replaced memory
- **DLL Injection**: Unexpected DLLs in process space
- **Reflective Loading**: In-memory DLL execution
- **Thread Injection**: Remote thread creation in other processes
- **Unhooking**: Attempts to remove EDR hooks

### Credential Access Indicators
- **LSASS Access**: Processes accessing lsass.exe memory
- **SAM Database**: Attempts to read SAM hive
- **NTDS.dit Access**: Domain controller credential extraction
- **Kerberos Attacks**: AS-REP roasting, Kerberoasting patterns
- **Token Manipulation**: Impersonation, token theft"""


# =============================================================================
# Malware Few-Shot Examples
# =============================================================================

MALWARE_EXAMPLES = """## Example Analyses

### Example 1: Cobalt Strike Beacon Detection

**Alert**: EDR detected suspicious PowerShell execution with encoded command.

**Process Details**:
```
Process: powershell.exe
PID: 4532
Parent: WINWORD.EXE (PID: 3128)
User: CORP\\jsmith
Command Line: powershell.exe -nop -w hidden -enc SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABO...
Working Directory: C:\\Users\\jsmith\\Downloads
```

**Analysis Output**:
```json
{
  "verdict": "malicious",
  "confidence": 95,
  "severity": "critical",
  "summary": "Cobalt Strike or similar post-exploitation framework detected. Word document spawned obfuscated PowerShell with encoded command containing a download cradle. This is a classic malicious macro execution chain.",
  "indicators": [
    {"type": "hash", "value": "d4f5e6a7b8c9...", "verdict": "malicious - Cobalt Strike stager"},
    {"type": "domain", "value": "cdn-static.xyz", "verdict": "malicious - known C2 infrastructure"},
    {"type": "ip", "value": "185.234.72.15", "verdict": "malicious - Cobalt Strike team server"}
  ],
  "mitre_techniques": [
    {"id": "T1059.001", "name": "PowerShell", "relevance": "Encoded PowerShell used for initial execution"},
    {"id": "T1566.001", "name": "Spearphishing Attachment", "relevance": "Word document delivered malicious payload"},
    {"id": "T1105", "name": "Ingress Tool Transfer", "relevance": "Download cradle fetching additional payload"},
    {"id": "T1071.001", "name": "Web Protocols", "relevance": "HTTP C2 communication"}
  ],
  "recommended_actions": [
    {"action": "Isolate host immediately", "priority": "immediate", "reason": "Active C2 communication indicates ongoing compromise"},
    {"action": "Block C2 domain and IP at perimeter", "priority": "immediate", "reason": "Prevent further communication with threat actor"},
    {"action": "Acquire memory dump for analysis", "priority": "high", "reason": "Preserve evidence of in-memory payload"},
    {"action": "Check for lateral movement", "priority": "high", "reason": "Cobalt Strike commonly used for internal pivoting"},
    {"action": "Reset user credentials", "priority": "high", "reason": "Assume credential compromise"}
  ],
  "reasoning": "This is a high-confidence detection of a post-exploitation framework (likely Cobalt Strike). Evidence chain: (1) Microsoft Word spawning PowerShell is a strong indicator of malicious macro execution, (2) PowerShell command line contains classic evasion flags (-nop -w hidden -enc), (3) Decoded base64 reveals IEX download cradle pointing to known malicious infrastructure, (4) Both the domain and IP are flagged in threat intel as Cobalt Strike C2. The execution from Downloads folder suggests user opened a malicious email attachment. Immediate containment required."
}
```

### Example 2: Legitimate Admin Tool False Positive

**Alert**: EDR detected potential LSASS credential access.

**Process Details**:
```
Process: MsMpEng.exe
PID: 1892
Parent: services.exe (PID: 672)
User: NT AUTHORITY\\SYSTEM
Path: C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\4.18.2301.6\\MsMpEng.exe
Target: lsass.exe
Access Mask: 0x1010
```

**Analysis Output**:
```json
{
  "verdict": "benign",
  "confidence": 92,
  "severity": "info",
  "summary": "False positive - Windows Defender antimalware service legitimately accessing LSASS as part of credential guard and memory scanning functionality. This is expected behavior from signed Microsoft security software.",
  "indicators": [
    {"type": "hash", "value": "abc123...", "verdict": "benign - signed Microsoft binary"},
    {"type": "process", "value": "MsMpEng.exe", "verdict": "benign - Windows Defender service"}
  ],
  "mitre_techniques": [],
  "recommended_actions": [
    {"action": "Add exclusion for Defender LSASS access", "priority": "medium", "reason": "Reduce alert fatigue from known good behavior"},
    {"action": "Verify binary signature", "priority": "low", "reason": "Confirm executable integrity"}
  ],
  "reasoning": "This alert is a false positive caused by legitimate security software. Analysis: (1) Process is MsMpEng.exe (Windows Defender) from official Platform directory, (2) Parent is services.exe indicating proper service initialization, (3) Running as SYSTEM which is expected for Defender, (4) File hash matches known Microsoft signed binary, (5) Access mask 0x1010 (PROCESS_QUERY_LIMITED_INFORMATION | PROCESS_VM_READ) is consistent with AV memory scanning. This is expected behavior from Credential Guard and realtime protection."
}
```

### Example 3: Suspicious Script Execution Requiring Investigation

**Alert**: PowerShell script execution from user profile.

**Process Details**:
```
Process: powershell.exe
PID: 6744
Parent: explorer.exe (PID: 4200)
User: CORP\\administrator
Command Line: powershell.exe -ExecutionPolicy Bypass -File C:\\Users\\administrator\\Scripts\\inventory.ps1
Working Directory: C:\\Users\\administrator\\Scripts
```

**Analysis Output**:
```json
{
  "verdict": "suspicious",
  "confidence": 60,
  "severity": "medium",
  "summary": "PowerShell script execution with bypass flag by administrator account. While potentially legitimate IT automation, the execution policy bypass and location warrant verification. No immediate threat indicators but deviates from baseline.",
  "indicators": [
    {"type": "hash", "value": "e5f6g7h8...", "verdict": "unknown - not in threat intel"},
    {"type": "file", "value": "inventory.ps1", "verdict": "unknown - requires content analysis"}
  ],
  "mitre_techniques": [
    {"id": "T1059.001", "name": "PowerShell", "relevance": "PowerShell execution with policy bypass"},
    {"id": "T1078", "name": "Valid Accounts", "relevance": "Administrator account used for execution"}
  ],
  "recommended_actions": [
    {"action": "Retrieve and analyze script contents", "priority": "high", "reason": "Determine script purpose and risk"},
    {"action": "Verify with administrator if expected", "priority": "high", "reason": "Confirm legitimate IT activity"},
    {"action": "Review script creation timestamp", "priority": "medium", "reason": "Determine how long script has existed"},
    {"action": "Check for similar executions in SIEM", "priority": "medium", "reason": "Determine if this is routine"}
  ],
  "reasoning": "This requires investigation but is not definitively malicious. Concerning factors: (1) ExecutionPolicy Bypass is often used maliciously but also by admins who haven't set proper GPO, (2) Running from user profile rather than managed script location, (3) Administrator account increases risk if compromised. Mitigating factors: (1) Parent is explorer.exe (interactive session, not spawned by malicious process), (2) No encoded commands or obvious obfuscation, (3) Script name suggests legitimate IT function. Need script content analysis and user verification before verdict."
}
```

### Example 4: Credential Dumping Attack

**Alert**: EDR detected memory access to LSASS by unknown process.

**Process Details**:
```
Process: notepad.exe
PID: 8876
Parent: cmd.exe (PID: 7654)
User: CORP\\svc_backup
Path: C:\\Windows\\System32\\notepad.exe
Target: lsass.exe
Access Mask: 0x1fffff
```

**Analysis Output**:
```json
{
  "verdict": "malicious",
  "confidence": 98,
  "severity": "critical",
  "summary": "Credential dumping attack detected. Notepad.exe (likely hollowed/injected) accessing LSASS with full access rights is a strong indicator of Mimikatz or similar credential harvesting tool. Service account compromise is likely.",
  "indicators": [
    {"type": "process", "value": "notepad.exe -> lsass.exe", "verdict": "malicious - abnormal access pattern"},
    {"type": "hash", "value": "xyz789...", "verdict": "suspicious - notepad hash differs from baseline"},
    {"type": "user", "value": "svc_backup", "verdict": "compromised - service account misuse"}
  ],
  "mitre_techniques": [
    {"id": "T1003.001", "name": "LSASS Memory", "relevance": "Direct credential extraction from LSASS"},
    {"id": "T1055.012", "name": "Process Hollowing", "relevance": "Notepad likely hollowed to host malicious code"},
    {"id": "T1078.002", "name": "Domain Accounts", "relevance": "Service account abused for credential access"}
  ],
  "recommended_actions": [
    {"action": "Isolate host immediately", "priority": "immediate", "reason": "Active credential theft in progress"},
    {"action": "Disable svc_backup account", "priority": "immediate", "reason": "Prevent lateral movement with stolen creds"},
    {"action": "Force password reset for all accounts on host", "priority": "immediate", "reason": "LSASS contains cached credentials"},
    {"action": "Hunt for svc_backup activity across environment", "priority": "high", "reason": "Determine scope of compromise"},
    {"action": "Acquire memory dump of notepad.exe", "priority": "high", "reason": "Identify exact tool used"}
  ],
  "reasoning": "This is unambiguous credential dumping. Critical indicators: (1) Notepad.exe should NEVER access LSASS - this is process hollowing/injection, (2) Access mask 0x1fffff is PROCESS_ALL_ACCESS - far more than any legitimate need, (3) Service account executing this suggests attacker has already compromised that credential, (4) CMD.exe parent indicates interactive attacker session. The notepad hash not matching baseline confirms the process has been tampered with. This is likely Mimikatz running inside a hollowed notepad process. Immediate credential rotation required for all accounts that have authenticated to this host."
}
```"""


# =============================================================================
# Complete Malware Prompt
# =============================================================================

MALWARE_PROMPT = f"""{SOC_ANALYST_PERSONA}

## Specialization: Malware and EDR Triage

You are specialized in analyzing malware-related alerts from Endpoint Detection and Response (EDR) \
systems. Your focus is on identifying malicious code execution, post-exploitation activity, and \
credential theft attempts.

### Relevant MITRE ATT&CK Techniques

**Command and Scripting Interpreter (T1059.*)**
- T1059.001 - PowerShell: Most common execution vector on Windows
- T1059.003 - Windows Command Shell: cmd.exe abuse
- T1059.005 - Visual Basic: VBS, VBA macro execution
- T1059.006 - Python: Python-based malware
- T1059.007 - JavaScript: JScript, Node.js abuse

**Process Injection (T1055.*)**
- T1055.001 - DLL Injection: Classic injection technique
- T1055.002 - Portable Executable Injection: PE injection
- T1055.003 - Thread Execution Hijacking: Hijacking existing threads
- T1055.012 - Process Hollowing: Replacing process memory

**OS Credential Dumping (T1003.*)**
- T1003.001 - LSASS Memory: Mimikatz-style attacks
- T1003.002 - Security Account Manager: SAM database access
- T1003.003 - NTDS: Domain controller credential extraction
- T1003.004 - LSA Secrets: Cached service account credentials
- T1003.006 - DCSync: Replicating credentials from DC

{MALWARE_INDICATORS}

{AVAILABLE_TOOLS}

{CHAIN_OF_THOUGHT_GUIDANCE}

{CONFIDENCE_SCORING_CRITERIA}

### Malware-Specific Confidence Modifiers
- **+20**: LSASS access by non-security software
- **+15**: Encoded PowerShell execution
- **+15**: Process injection detected
- **+10**: LOLBAS execution with suspicious arguments
- **+10**: Hash matches known malware
- **-15**: Signed Microsoft/trusted vendor binary
- **-10**: Known IT automation or management tool
- **+25**: Multiple MITRE techniques in single execution chain

{MALWARE_EXAMPLES}

## Required Output Format

You MUST respond with a JSON object matching this schema:

```json
{format_output_schema()}
```

Important:
- Always include ALL fields in your response
- Confidence must be an integer between 0 and 100
- Include at least one recommended action
- Your reasoning should explain your thought process step by step
- Map to MITRE ATT&CK techniques T1059.*, T1055.*, T1003.* as appropriate"""


def get_malware_triage_prompt(
    alert_context: str,
    include_examples: bool = True,
    organization_context: str | None = None,
) -> str:
    """
    Generate a complete malware triage prompt with alert context.

    Args:
        alert_context: Formatted alert data to analyze.
        include_examples: Whether to include few-shot examples.
        organization_context: Optional organization-specific context.

    Returns:
        Complete prompt ready for LLM.
    """
    prompt_parts = [MALWARE_PROMPT]

    if organization_context:
        prompt_parts.append(f"""## Organization Context

{organization_context}""")

    prompt_parts.append(
        f"""## Alert to Analyze

{alert_context}

Analyze this EDR alert following the methodology above. Gather additional evidence using the available \
tools as needed (threat intel lookups, SIEM correlation, host context), then provide your structured assessment."""
    )

    return "\n\n".join(prompt_parts)


def build_edr_alert_context(
    alert_id: str,
    alert_name: str,
    process_info: dict,
    parent_process: dict | None = None,
    network_activity: list[dict] | None = None,
    file_operations: list[dict] | None = None,
    registry_operations: list[dict] | None = None,
    detection_source: str = "EDR",
    severity_from_edr: str | None = None,
) -> str:
    """
    Build formatted context for an EDR/malware alert.

    Args:
        alert_id: Unique alert identifier.
        alert_name: Name/title of the detection.
        process_info: Dictionary with process details.
        parent_process: Optional parent process information.
        network_activity: List of network connections.
        file_operations: List of file operations.
        registry_operations: List of registry modifications.
        detection_source: Source EDR product.
        severity_from_edr: EDR's severity assessment.

    Returns:
        Formatted alert context string.
    """
    import json

    parts = [
        f"**Alert ID**: {alert_id}",
        f"**Detection Name**: {alert_name}",
        f"**Source**: {detection_source}",
    ]

    if severity_from_edr:
        parts.append(f"**EDR Severity**: {severity_from_edr}")

    parts.append(f"\n**Process Information**:\n```json\n{json.dumps(process_info, indent=2)}\n```")

    if parent_process:
        parts.append(f"\n**Parent Process**:\n```json\n{json.dumps(parent_process, indent=2)}\n```")

    if network_activity:
        parts.append(
            f"\n**Network Activity**:\n```json\n{json.dumps(network_activity, indent=2)}\n```"
        )

    if file_operations:
        parts.append(
            f"\n**File Operations**:\n```json\n{json.dumps(file_operations, indent=2)}\n```"
        )

    if registry_operations:
        parts.append(
            f"\n**Registry Operations**:\n```json\n{json.dumps(registry_operations, indent=2)}\n```"
        )

    return "\n".join(parts)
